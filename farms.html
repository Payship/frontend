<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Synthetic Decentralized Exchange Secured by VSDC and Chainlink.">

    <title>Payship.org FARMS</title>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:100,400,700,900">
    <link rel="stylesheet" type="text/css" href="static/styles.css">
    <script type="text/javascript" src="static/scripts.js"></script>
    <script type="text/javascript">const version = 'v1.2.4'; const variant = 'D';</script>

    <style rel="stylesheet">
        h1 {
            font-size: 4rem;
        }
        sub {
            top: 0;
        }

        #from-balance,
        #farm-balance,
        #to-balance,
        table tr {
            cursor: pointer;
        }

        th, td {
            text-align: right;
        }

        th:first-child,
        td:first-child {
            text-align: left;
        }

        th small,
        strong small {
            font-weight: bold;
        }

        a.text-muted {
            text-decoration: underline;
        }

        .btn-hidden {
            display: none;
        }

        .btn-secondary {
            background-color: #07b;
        }

        .btn-lg {
            padding: .5rem 2rem;
        }

        .custom-select {
            flex: none !important;
            width: 7.5rem !important;
        }

        .font-mono {
            font-family: monospace;
            font-size: 12px;
        }

        .text-left {
            float: left;
        }

        .td-bald {
            border-top: none !important;
        }

        .td-thick {
            border-bottom: 2px solid !important;
        }

        .td-ghost {
            opacity: 0.25;
        }

        .td-ghostly {
            opacity: 0.5;
        }

        .navbar-nav {
            color: #c0c;
        }

        #from-balance *,
        #farm-balance *,
        #to-balance * {
            font-size: 0.66rem !important;
            font-weight: normal !important;
        }

        #folio-modal button.close {
            margin-top: -0.66rem;
        }
        
        #version {
            text-transform: lowercase !important;
        }
    </style>
    <link href="data:image/x-icon;base64,AAABAAEAEBAAAAAAAABoBQAAFgAAACgAAAAQAAAAIAAAAAEACAAAAAAAAAEAAAAAAAAAAAAAAAEAAAAAAAD///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=" rel="icon" type="image/x-icon">
</head>
<body>

    <!-- Navigation -->
    <nav id="header" class="navbar navbar-expand-lg navbar-dark navbar-custom fixed-top">
        <div class="container">
            <a class="navbar-brand" href="/"><span class="symbol">(+)</span> PAYSHIP<sub>/FARMS <small id="version">v-.-.-</small></sub></a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse text-right pr-3" id="navbarResponsive">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html"><span>«BACK</span></a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <a id="swap"><br /><br /></a>

    <section>
        <div class="container">
            <div id="container-vsync" class="row align-items-top">
                <div class="col-lg-6">
                    <div class="pt-5 pb-5">
                        <h6 class="text-center">DEPOSIT OR WITHDRAW</h6>
                        <hr />
                        <form class="shadow-lg p-3 mb-5 bg-white rounded">
                            <input id="swapApproval" type="hidden" value="1000000000000000000">
                            <small class="form-text text-white text-left font-mono badge bg-danger"><span id="eth-address">NO WALLET CONNECTED</span></small>
                            <small class="form-text text-muted text-right font-mono">
                                Wallet: <span id="from-balance" alt="from-swap">&mdash;</span>
                                <br />
                                Farm: <span id="farm-balance" alt="from-swap">&mdash;</span>
                            </small>
                            <div id="from-swap" class="input-group mt-1 mb-1">
                                <input type="decimal" class="form-control form-control-lg" placeholder="0.0" aria-label="Amount" disabled>
                                <button alt="from-swap" type="button" value="VSDC" class="form-control custom-select custom-select-lg" aria-label="Swap From Token" data-toggle="modal" data-target="#folio-modal" disabled>VSDC</button>
                            </div>
                            <div class="text-center">
                                <button id="btn-deposit" type="button" class="btn btn-lg btn-secondary rounded-pill mt-3 mb-3">Connect Wallet</button>
                                &nbsp;
                                <button id="btn-withdraw" type="button" class="btn btn-lg btn-danger btn-hidden rounded-pill mt-3 mb-3">Withdraw</button>
                            </div>
                            <small class="form-text text-muted float-right mt-0 btn-hidden">
                                <span id="to-size">1</span> <span id="to-ticker">VSDC</span> = <span id="from-size">&mdash;</span> <span id="from-ticker">VSDC</span>
                            </small>
                            <div class="text-danger text-center"><span id="alert-error"></span></div>
                        </form>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div id="folio-tos" class="p-5">
                        <br /><br />
                        <p><small>
                            This website is an instance of the open source interface to the Payship platform. You too can host this interface using nothing more than a static hosting web server. Go to <a href="https://github.com/Payship/frontend">Payship GitHub</a> to see how.
                            <hr />
                            Regulators, particularly in the US and EU, are always trying to expand their oppressive measures of control under the disguise of "protecting" the investors. We believe that investors are smart, diligent &amp; independent adults. Therefore, please acknowledge that by connecting your self-custodian wallet to this service you are accepting the following Terms of Service:<br />
                            <strong>You shall use this service only with accordance of all the laws and regulations you are currently under. We shall bear no responsibility over unlawful or unregulated use of this service. This is an interface to experimental smart contracts. Your funds are at risk.</strong> DYOR NFA YOLO.
                        </small></p>
                    </div>
                    <div id="folio-box" class="pt-5 pb-5" style="display: none">
                        <h6 class="text-center">YOUR PORTFOLIO</h6>
                        <hr />

                        <div class="table-responsive">
                            <table id="folio" class="table table-hover table-sm table-folio">
                                <thead>
                                    <tr>
                                        <th class="td-bald"><small>Wallet</small></th>
                                        <th class="td-bald"><small>Balance</small></th>
                                        <th class="td-bald"><small>Price</small></th>
                                        <th class="td-bald"><small>Value</small></th>
                                    </tr>
                                </thead>

                                <!--<tbody id="folio-eth">
                                    <tr value="ETH">
                                        <td>ETH</td>

                                        <td><span id="balance-eth" class="balance">&mdash;</span></td>
                                        <td><small>$</small><span class="price-eth">&mdash;</span></td>
                                        <td><small>$</small><span id="value-eth">&mdash;</span></td>
                                    </tr>
                                </tbody>-->

                                <tbody id="folio-vsdc">
                                    <tr value="VSDC">
                                        <td>VSDC</td>

                                        <td><span id="balance-vsdc" class="balance">&mdash;</span></td>
                                        <td><small>$</small><span class="price-vsdc" alt="1000000000000000000"><strong>1.<small>00</small></strong></span></td>
                                        <td><small>$</small><span id="value-vsdc">&mdash;</span></td>
                                    </tr>
                                </tbody>

                                <!--<tbody id="folio-vpts-vsdc">
                                    <tr value="XPSHP-VSDC">
                                        <td>XPSHP+VSDC</td>

                                        <td><span id="balance-vpts" class="balance">&mdash;</span></td>
                                        <td></td>
                                        <td></td>
                                    </tr>
                                </tbody>-->

                                <thead id="tips">
                                    <tr>
                                        <td colspan="4" class="text-center">
                                            <small class="text-muted text-info"><a href="#">Get VSDC</a><!-- or <a href="#">Pool XPSHP+VSDC</a>-->. Deposit assets to start farming XP.</small>
                                        </td>
                                    </tr>
                                </thead>
                                
                                <thead>
                                        <tr>
                                            <th class="td-bald"><br /><small id="synts-title">Farms</small></th>
                                            <th class="td-bald"><br /><small>Balance</small></th>
                                            <th class="td-bald"><br /><small></small></th>
                                            <th class="td-bald"><br /><small>APR</small></th>
                                        </tr>
                                </thead>
                                <tbody id="folio-farms" class="table-folio-farms">
                                    <tr value="VSDC">
                                        <td>§VSDC</td>

                                        <td><span id="farm-balance-vsdc" class="balance">&mdash;</span></td>
                                        <td></td>
                                        <td>100%</td>
                                    </tr>
                                    <!--<tr value="farm-vpts-vsdc">
                                        <td>§XPSHP+VSDC</td>

                                        <td><span id="farm-balance-vpts-eth" class="balance">&mdash;</span></td>
                                        <td></td>
                                        <td>100%</td>
                                    </tr>-->
                                </tbody>
                            </table>
                        </div>

                        <br /><br />

                        <h6 class="text-center">FARM XP</h6>
                        <hr />

                        <div class="row">
                            <div class="col-sm-6">
                                Farm Value: $<span id="value-farm">&mdash;</span><br />
                                <small class="text-info text-muted">
                                    Your deposits farm XP at 100% APR.
                                </small>
                            </div>
                            <div class="col-sm-6 text-right">
                                Unclaimed: <span id="value-points">&mdash;</span> XPSHP<br />
                                <a href="#" id="btn-claim"><b>CLAIM NOW</b></a>
                            </div>
                        </div>

                        <hr />

                        <div class="row">
                            <div class="col-sm-12">
                                <a href="#" id="btn-display"><b>ADD TO METAMASK</b></a><br />
                                <small class="text-info text-muted">
                                    Display all Payship tokens in your wallet list on apps like MetaMask.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <header class="masthead text-center text-white">
        <div class="masthead-content">
            <div class="container">
                <h1 class="masthead-heading mb-0"></h1>
                <br />
                <h6 class="mb-0 text-muted">Synthetic Decentralized Exchange Secured by VSDC &amp; Chainlink</h6>
                <br />
                <h1 class="mt-0 mb-2"><span class="symbol">(+)</span> PAYSHIP/<sub>FARMS</sub></h1>
                <br />
                <h5 class="mt-2">Play with DeFi&mdash;Forget slippage, bots &amp; mev. Get low fees &amp; low gas.</h5>
                <br />
            </div>
        </div>
    </header>

    <div id="folio-modal" class="modal" tabindex="-1" aria-labelledby="folio-modal" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <input id="modal-search" type="text" class="form-control" placeholder="Search ticker..." />
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Portfolio</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="py-5 bg-black">
        <div class="container">
            <p class="m-0 text-center text-uppercase small"><a href="index.html">HOME</a></p>
            <hr />
            <p class="m-0 text-center text-white small"><span class="symbol">(-§-)</span> PAYSHIP.org &copy; 2021&mdash;2024</p>
        </div>
        <!-- /.container -->
    </footer>

    <script type="text/javascript">
"use strict";

const CID = 8453; // 1 - Mainnet, 5 - Goerli, 11155111 - Sepolia, 8453 - Base Mainnet, 84532 - Base Sepolia
const sVSDC = ethers.utils.keccak256(ethers.utils.toUtf8Bytes("VSDC"));

let accounts;
let provider;
let network;
let signer;

let allFarms;
let allTickers = [];

let lastAddress;
let lastVsdcBalance;
let lastFarmBalance;
let lastPointsBalance;

let preloadPriceInterval;
let livePriceInterval;

let lastSubmitButton = 'btn-deposit';
let lastSwapButton = 'from-swap';
let lastSwapFrom = 'VSDC';
let lastSwapTo = 'ETH';
let modalOpen = false;

let totalFarms = 0;
let preloadSid = 1;

let lastSidFrom = 0;
let lastSidTo = 0;

let vsdcContract;
let farmlendContract;


async function onConnect() {
    if (confirm("Terms of Service: You shall use this service only with accordance of all the laws and regulations you are currently under. We shall bear no responsibility over unlawful or unregulated use of this service. This is an interface to experimental smart contracts. Your funds are at risk. DYOR NFA YOLO & F#CK SEC.")) {

        if (window.ethereum) {
            provider = new ethers.providers.Web3Provider(window.ethereum)
            accounts = await provider.send("eth_requestAccounts", []);
            afterConnect();
        }
        else if (window.web3) {
            provider = new ethers.providers.Web3Provider(window.web3.currentProvider);
            accounts = provider.provider.accounts;
            afterConnect();
        }

    }

    return false;
}

async function updateVsdcBalance() {
    try {
        lastVsdcBalance = await vsdcContract.balanceOf(lastAddress);
    }
    catch (error) {
        lastVsdcBalance = 0;
        console.log("lastVsdcBalance\n\n" + error);
    }
}

async function updateFarmBalance() {
    try {
        lastFarmBalance = await farmlendContract.userInfo(0,lastAddress);
        lastFarmBalance = lastFarmBalance.amount;
    }
    catch (error) {
        lastVsdcBalance = 0;
        console.log("lastVsdcBalance\n\n" + error);
    }
}

async function updatePointsBalance() {
    try {
        lastPointsBalance = await farmlendContract.pendingPoints(0,lastAddress);
    }
    catch (error) {
        lastPointsBalance = 0;
        console.log("lastPointsBalance\n\n" + error);
    }
}

async function updateTotalFarms() {
    if (totalFarms == 0) {
        try {
            totalFarms = await farmlendContract.poolLength();
        }
        catch (error) {
            console.log("totalFarms\n\n" + error);
        }
    }
}

async function updateAssets() {
    await updateVsdcBalance();
    await updateFarmBalance();
    await updatePointsBalance()

    $('#balance-vsdc').html(prixNum(forComm(forNum(lastVsdcBalance)),6)).attr('value',forNum(lastVsdcBalance));
    $('#farm-balance-vsdc').html(prixNum(forComm(forNum(lastFarmBalance)),6)).attr('value',forNum(lastFarmBalance));

    $('#value-farm').html(prixNum(forComm(forNum(lastFarmBalance)),0)).attr('value',forNum(lastFarmBalance));
    $('#value-vsdc').html(prixNum(forComm(forNum(lastVsdcBalance)),0));
    $('#value-points').html(prixNum(forComm(forNum(lastPointsBalance)),4));
    $('#synts-title').text('Farms loading...');

    if ($('#from-swap button').val() == 'VSDC') {
        $('#from-balance').html(prixNum(forNum(lastVsdcBalance))).attr('value',forNum(lastVsdcBalance));
        $('#farm-balance').html(prixNum(forNum(lastFarmBalance))).attr('value',forNum(lastFarmBalance));
    }

    $('#folio tbody tr').click(onTickerSelect);
    $('#synts-title').text('Farms');
    $('#btn-deposit').text('Deposit').removeClass('btn-secondary').addClass('btn-success');

    enableUI();
}

async function afterConnect() {
    $('#btn-deposit').text('Loading . . .');

    $('#folio-tos').hide();
    $('#folio-box').show();

    network = await provider.getNetwork();
    lastAddress = accounts[0];

    try {
        if (network.chainId != CID) {
            await provider.send("wallet_switchEthereumChain",[{ chainId: ethers.utils.hexValue(CID) }]);
            window.location.reload(true);
        }
    }
    catch (error) {
        if (CID == 84532) {
            await provider.send("wallet_addEthereumChain",[{
                chainId: "0x14a34",
                rpcUrls: ["https://sepolia.base.org/"],
                chainName: "Base Sepolia",
                nativeCurrency: {
                  name: "ETH",
                  symbol: "ETH",
                  decimals: 18
                },
                blockExplorerUrls: ["https://sepolia.basescan.org/"]
            }]);
        }
        if (CID == 8453) {
            await provider.send("wallet_addEthereumChain",[{
                chainId: "0x2105",
                rpcUrls: ["https://mainnet.base.org/"],
                chainName: "Base Mainnet",
                nativeCurrency: {
                  name: "ETH",
                  symbol: "ETH",
                  decimals: 18
                },
                blockExplorerUrls: ["https://basescan.org/"]
            }]);
        }
        window.location.reload(true);
    }

    signer = provider.getSigner();

    vsdcContract = new ethers.Contract(VSDCAddress, VSDCABI, signer);
    farmlendContract = new ethers.Contract(FarmlendAddress, FarmlendABI, signer);

    updateAssets();

    $('#eth-address').text(forAdd(lastAddress)).parent().removeClass('bg-danger').addClass('bg-success');

    document.querySelector("#btn-deposit").removeEventListener("click", onConnect);
    document.querySelector("#btn-deposit").addEventListener("click", onDeposit);
    document.querySelector("#btn-withdraw").addEventListener("click", onWithdraw);

    document.querySelector("#modal-search").addEventListener('keyup', onModalSearch);

    $('#btn-claim').click(onClaim);
    $('#btn-display').click(displayTokens);

    $('#from-swap input').on('input',onValueChange);
    $('#from-swap button').click(onTickerClick);
    $('#from-balance, #farm-balance, #to-balance').click(onBalanceClick);
}

async function onCheckAllowance() {
    if($('#from-swap button').val() == 'VSDC') {
        let offer = toBigNum('#from-swap input').toString();
        let address = FarmlendAddress;
        let allowance = await vsdcContract.allowance(lastAddress,address);

        if (bigLt(allowance,offer)) {
            $('#btn-deposit').text('Approve').removeClass("btn-success").addClass("btn-primary");
            $('#btn-withdraw').hide();
            document.querySelector("#btn-deposit").removeEventListener("click", onDeposit);
            document.querySelector("#btn-deposit").addEventListener("click", onApprove);
        }
        else {
            $('#btn-deposit').text('Deposit').removeClass("btn-primary").addClass("btn-success");
            $('#btn-withdraw').show();
            document.querySelector("#btn-deposit").removeEventListener("click", onApprove);
            document.querySelector("#btn-deposit").addEventListener("click", onDeposit);
        }
    }
}

function onBalanceClick() {
    let source = '#' + $(this).attr('id');
    let target = '#from-swap';

    $(target + ' input').val($(source).attr('value'));
    onValueChangeProcess($(target));
}

async function onTickerClick(event) {
    const modalBody = document.querySelector('.modal-body');
    const folioTable = document.querySelector('#folio').cloneNode(true);

    modalBody.innerHTML = '';
    modalBody.appendChild(folioTable);
    lastSwapButton = $(event.target).attr('alt');
    modalOpen = true;

    $('.modal-body .table-folio tbody tr').click(onTickerSelect);
}

async function onTickerSelect(event,source,pass = 0) {
    const origin = source ? source : this;
    const ticker = $(origin).attr('value');

    let balanceWallet = $('#balance-' + ticker.toLowerCase()).attr('value');
    let balanceFarm = $('#farm-balance-' + ticker.toLowerCase()).attr('value');
    
    $('#from-balance').html(prixNum(balanceWallet)).attr('value',balanceWallet);
    $('#farm-balance').html(prixNum(balanceFarm)).attr('value',balanceFarm);

    $('#' + lastSwapButton + ' button').text(ticker).val(ticker);
    $('#folio-modal').modal('hide');
    modalOpen = false;

    lastSwapButton = 'from-swap';
    onTickerChange(event,origin,pass);
}

function onModalSearch(event) {
    let input = event.target.value.toLowerCase();
    const tableRows = document.querySelectorAll('.modal-body .table-folio tbody tr');

    for (let row of tableRows) {
        let tickerCell = row.cells[0];
        let tickerText = toClass(tickerCell.innerText);

        if (tickerText.startsWith(input)) {
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    }
}

async function onTickerRotate() {
    let tempValue = $('#from-swap input').val();
    let tempTicker = $('#from-swap button').val();
    let tempText = $('#from-swap button').text();
    let tempBalance = $('#from-balance').html();
    let tempBalanceValue = $('#from-balance').attr('value');

    $('#from-swap input').val( $('#to-swap input').val() );
    $('#from-swap button').val( $('#to-swap button').val() );
    $('#from-swap button').text( $('#to-swap button').text() );
    $('#from-balance').html( $('#to-balance').html() ).attr('value', $('#to-balance').attr('value') );

    $('#to-swap input').val(tempValue);
    $('#to-swap button').val(tempTicker).text(tempText);
    $('#to-balance').html(tempBalance).attr('value',tempBalanceValue);

    lastSwapButton = 'to-swap';
    lastSwapFrom = $('#from-swap button').val();
    lastSwapTo = $('#to-swap button').val();

    onCheckAllowance();
    onTickerChange();

    return false;
}

async function onValueChange(event) {
    let thisTarget = $(event.currentTarget);
    onValueChangeProcess(thisTarget.parent());
}

function onValueChangeProcess(thisParent) {
    let pp = getPairPrice();

    if (thisParent.attr('id') == 'from-swap') {
        let fromValue = $('#from-swap input').val();

        if (parseFloat(fromValue) > 0) {
            if ($('#from-swap button').val() == 'VSDC') {
                onCheckAllowance();
            }
        }
    }

    return false;
}

async function updateSizePrice(pp) {
    $('#from-size').html(prixNum(forComm(forNum(bigDiv(bigMul("1000000000000000000",pp.to),pp.from))),2));
}

async function onTickerChange(event,source,pass) {
    // if (pass == 0) {
    //     pass += 1;

    //     if ($(source).attr('value') == 'ETH') {
    //         if ($('#from-swap button').text() == 'ETH') {
    //             onTickerSelect(event,$('#folio-vsdc tr'),pass);
    //             return false;
    //         }

    //         if ($('#to-swap button').text() == 'ETH') {
    //             lastSwapButton = 'from-swap';
    //             onTickerSelect(event,$('#folio-vsdc tr'),pass);
    //             return false;
    //         }
    //     }
    //     else if ($(source).attr('value') != 'VSDC') {
    //         if ($('#from-swap button').text() == 'ETH') {
    //             lastSwapButton = 'from-swap';
    //             onTickerSelect(event,$('#folio-vsdc tr'),pass);
    //             return false;
    //         }

    //         if ($('#to-swap button').text() == 'ETH') {
    //             lastSwapButton = 'to-swap';
    //             onTickerSelect(event,$('#folio-vsdc tr'),pass);
    //             return false;
    //         }
    //     }
    // }

    // $('#from-ticker').text( $('#from-swap button').text() );
    // $('#to-ticker').text( $('#to-swap button').text() );

    // let pp = getPairPrice();
    //          updateSizePrice(pp);

    // if (lastSwapButton == 'from-swap') {
    //     // onValueChangeProcess($('#to-swap'));
    // }
    // else {
    //     onValueChangeProcess($('#from-swap'));
    // }

    // if ((pp.fromTicker == 'VSDC' && pp.toTicker == '§VSDC') ||
    //     (pp.fromTicker == '§VSDC' && pp.toTicker == 'VSDC') ) {
    //     $('#fee').text('0');
    // }
    // else if (pp.fromTicker == 'ETH' || pp.toTicker == 'ETH' ) {
    //     $('#fee').text('0.5');
    // }
    // else {
    //     $('#fee').text('0.5');
    // }

    // lastSidFrom = allTickers[pp.fromTicker];
    // lastSidTo = allTickers[pp.toTicker];

    // updatePrice(lastSidFrom);
    // updatePrice(lastSidTo);

    // if (livePriceInterval) clearInterval(livePriceInterval);
    // livePriceInterval = setInterval(function () { updatePrice(lastSidFrom); updatePrice(lastSidTo); }, 15000);

    return false;
}

function getPairPrice() {
    let fromTicker = $('#from-ticker').text();
    // let toTicker = $('#to-ticker').text();

    let fromTickerClass = toClass(fromTicker);
    // let toTickerClass = toClass(toTicker);

    let fromSize = toBigNum('#from-swap input');
    // let toSize = toBigNum('#to-swap input');

    let fromPrice = $('.price-' + fromTickerClass).attr('alt');
    // let toPrice = $('.price-' + toTickerClass).attr('alt');
    
    return { 
            fromTicker: fromTicker,
            fromSize: fromSize,
            from: fromPrice, 

            // toTicker: toTicker,
            // toSize: toSize,
            // to: toPrice
        };
}

async function displayTokens() {
    try {
        // Request MetaMask to add the token
        await window.ethereum.request({
            method: 'wallet_watchAsset',
            params: {
                type: 'ERC20',
                options: {
                    address: VSDCAddress,
                    symbol: "VSDC",
                    decimals: 18,
                    image: "https://payship.org/static/img/logo_vsdc.png",
                },
            },
        });

        await window.ethereum.request({
            method: 'wallet_watchAsset',
            params: {
                type: 'ERC20',
                options: {
                    address: XPTSAddress,
                    symbol: "XPSHP",
                    decimals: 18,
                    image: "https://payship.org/static/img/logo_vpts.png",
                },
            },
        });

    } catch (error) {
        console.error('Error adding token:', error);
    }

    return false;
}

function beforeTransaction() {
    $('#' + lastSubmitButton).text('Waiting . . .');
    disableUI();

    return false;
}

async function onDeposit() {
    lastSubmitButton = 'btn-deposit';
    let pp = getPairPrice();

    if (pp.fromSize == undefined|| 
        pp.fromSize == null ||
        pp.fromSize == 0) return false;

    let tx = beforeTransaction();

    try {
        if (pp.fromTicker == 'VSDC') {
            tx = await farmlendContract.deposit(0,pp.fromSize);
        }
    } catch (error) {
        console.log(error);

        let reason = 'Error! ' + error.reason + '. <a href="/farms.html" class="text-muted">Refresh page</a>';
        $('#alert-error').html(reason);
    }

    onTransaction(tx);

    return false;
}

async function onWithdraw() {
    lastSubmitButton = 'btn-withdraw';
    let pp = getPairPrice();

    if (pp.fromSize == undefined|| 
        pp.fromSize == null ||
        pp.fromSize == 0) return false;

    let tx = beforeTransaction();

    try {
        if (pp.fromTicker == 'VSDC') {
            tx = await farmlendContract.withdraw(0,pp.fromSize);
        }
    } catch (error) {
        console.log(error);

        let reason = 'Error! ' + error.reason + '. <a href="/farms.html" class="text-muted">Refresh page</a>';
        $('#alert-error').html(reason);
    }

    onTransaction(tx);

    return false;
}

async function onApprove() {
    lastSubmitButton = 'btn-deposit';
    let pp = getPairPrice();
    let tx = beforeTransaction();

    let contractAddress = FarmlendAddress;

    try {
        tx = await vsdcContract.approve(contractAddress, toBigNum('#swapApproval'));
    } catch (error) {
        console.log(error);
    }

    onTransaction(tx);

    return false;
}

async function onClaim(event) {
    let tx;
    let v;

    event.preventDefault();

    try {
        tx = await farmlendContract.deposit(0,0); onClaimTransaction(tx);
    }
    catch (error) {
        console.log("onClaim\n\n" + error);
    }

    return false;
}

async function onClaimTransaction(tx) {
    if (tx) {
        await tx.wait().then(function(result) {
            if (result.status) {
                updatePointsBalance();

                setTimeout(function() {
                    $('.value-points').html(prixNum(forComm(forNum(lastPointsBalance)),4));
                }, 3000)
            }
        });
    }
}

async function onTransaction(tx) {
    if (tx) {
        $('#' + lastSubmitButton).text('Confirming . . .');

        await tx.wait().then(function(result) {
            enableUI();

            if (result.status) {
                updateAssets();
                $('#' + lastSubmitButton).text('Confirmed !');
            }
            else {
                $('#' + lastSubmitButton).text('Failure !');
            }

            setTimeout(function() {
                document.querySelector("#btn-deposit").removeEventListener("click", onApprove);
                document.querySelector("#btn-deposit").addEventListener("click", onDeposit);

                $('#' + lastSubmitButton).removeClass("btn-primary").removeClass("btn-secondary");

                if (lastSubmitButton == 'btn-deposit') {
                    $('#' + lastSubmitButton).addClass("btn-success").text('Deposit');
                }
                else if (lastSubmitButton == 'btn-withdraw') {
                    $('#' + lastSubmitButton).addClass("btn-danger").text('Withdraw');
                }

                lastSubmitButton = 'btn-deposit';
            }, 3000)
        });
    }
    else {
        enableUI();
    }
}

window.addEventListener('load', async () => {
    $('#version').text(version);

    $.getScript('static/structs-' + CID + '-' + variant + '.js?ver=' + version, function() {
        document.querySelector("#btn-deposit").addEventListener("click", onConnect);
        onConnect();
    });
});

function toClass(val,lc = true) {
    val = val.replace('§','')

    if (lc) return val.toLowerCase();
    return val;
}

function toBytes(val) {
    return ethers.utils.id(val);
}

function toBigNum(selector,dec = 18) {
    return ethers.utils.parseUnits(($(selector).val() ? $(selector).val() : '0'),dec);
}

function bigNum(num,dec = 18) {
    return ethers.utils.parseUnits(num,dec);
}

function bigAdd(above,below) {
    return ethers.BigNumber.from(above).add(below);
}

function bigMul(above,below,divide = false) {
    if (divide) return ethers.BigNumber.from(above).mul(below).div("1000000000000000000");
    return ethers.BigNumber.from(above).mul(below);
}

function bigDiv(above,below) {
    if (below == 0) below = 1;
    return ethers.BigNumber.from(above).div(below);
}

function bigLt(above,below,cast = false) {
    if (cast) {
        above = to18(above);
        below = to18(below);
    }

    return ethers.BigNumber.from(above).lt(below);
}

function forNum(val, dec = 18) {
    return ethers.utils.formatUnits(val.toString(), dec);
}

function forComm(val) {
    return ethers.utils.commify(val);
}

function prixNum(price, acc = 16) {
    let parts = price.toString().split('.');

    if (parts.length < 2 || parts[1].length <= 2) {
        if (parts[1].length == 1) parts[1] += '0';

        let partsSupplement = '';
        for (var i = acc; i > 0; i--) partsSupplement += '0';

        return '<strong>' + parts[0] + '.' + '<small>' + parts[1] + '</small></strong><small>' + partsSupplement + '</small>';
    }

    let fractionalParts = [parts[1].substr(0, 2), parts[1].substr(2)];
    let fractionalPartsSupplement = acc - fractionalParts[1].length;

    for (var i = fractionalPartsSupplement; i > 0; i--) fractionalParts[1] += '0';

    fractionalParts[1] = fractionalParts[1].substr(0, acc);
    fractionalParts[1] = '<small>' + fractionalParts[1] + '</small>';

    return '<strong>' + parts[0] + '.' + '<small>' + fractionalParts[0] + '</small></strong>' + fractionalParts[1];
}

function txtNum(val) {
    return forComm(forNum(bigNum(val)));
}

function forAdd(val) {
    return val.replace(val.substring(6,38),'..')
}

function enableUI() {
    $('#from-balance, #to-balance, #from-swap input, #from-swap button, #to-swap input, #btn-deposit').removeAttr('disabled');
    $('#btn-withdraw').show();
}

function disableUI() {
    $('#from-balance, #to-balance, #from-swap input, #from-swap button, #to-swap input, #btn-deposit').attr('disabled', true);
    $('btn-withdraw').hide();
}

    </script>
</body>
</html>
